{% extends 'core/base.html' %}
{% block title %}Authorized MCN{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header" style="background-color: #0070C0; color: white;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Authorize (MCN)</h5>
            </div>
        </div>
        <div class="card-body">
            <!-- Search Section with Autocomplete -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <form method="get" class="form-inline" id="search-form">
                        <div class="form-group mr-2">
                            <select name="search_type" id="search-type" class="form-control form-control-sm">
                                <option value="1" {% if search_type == '1' %}selected{% endif %}>WO No</option>
                                <option value="0" {% if search_type == '0' %}selected{% endif %}>Customer</option>
                                <option value="2" {% if search_type == '2' %}selected{% endif %}>Project Title</option>
                            </select>
                        </div>
                        <div class="form-group mr-2 position-relative" style="flex: 1; max-width: 400px;">
                            <input type="text"
                                   name="search"
                                   id="search-input"
                                   class="form-control form-control-sm w-100"
                                   placeholder="Type to search..."
                                   value="{{ search_query }}"
                                   autocomplete="off"
                                   hx-get="{% url 'quality_control:authorized-mcn-autocomplete' %}"
                                   hx-trigger="keyup changed delay:300ms"
                                   hx-target="#autocomplete-results"
                                   hx-include="#search-type"
                                   hx-vals='js:{q: document.getElementById("search-input").value}'>
                            <div id="autocomplete-results" class="autocomplete-dropdown"></div>
                        </div>
                        <button type="submit" class="btn btn-sm btn-danger">Search</button>
                        {% if search_query %}
                        <a href="{% url 'quality_control:authorized-mcn-list' %}" class="btn btn-sm btn-secondary ml-2">Clear</a>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Results Count -->
            {% if total_count %}
            <div class="row mb-2">
                <div class="col-md-12">
                    <small class="text-muted">Showing {{ work_orders|length }} of {{ total_count }} work orders</small>
                </div>
            </div>
            {% endif %}

            <!-- Work Orders Table -->
            <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover">
                    <thead style="background-color: #f8f9fa;">
                        <tr>
                            <th style="width: 50px;">SN</th>
                            <th>WO No</th>
                            <th>Date</th>
                            <th>Project Title</th>
                            <th>Customer Name</th>
                            <th style="width: 80px;">Code</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wo in work_orders %}
                        <tr style="cursor: pointer;">
                            <td>{{ forloop.counter|add:page|add:"-1"|add:"0"|stringformat:"d" }}</td>
                            <td>
                                <a href="{% url 'quality_control:authorized-mcn-detail' wo.wo_no %}"
                                   style="color: #0070C0; text-decoration: underline;">
                                    {{ wo.wo_no }}
                                </a>
                            </td>
                            <td>{{ wo.wo_date }}</td>
                            <td>{{ wo.project_title }}</td>
                            <td>{{ wo.customer_name }}</td>
                            <td>{{ wo.code }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                {% if search_query %}
                                    No work orders found matching "{{ search_query }}"
                                {% else %}
                                    No work orders with MCN records found
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if total_pages > 1 %}
            <div class="row mt-3">
                <div class="col-md-12 text-center">
                    <nav>
                        <ul class="pagination pagination-sm justify-content-center">
                            {% if has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page|add:"-1" }}{% if search_query %}&search={{ search_query }}&search_type={{ search_type }}{% endif %}">
                                    &laquo; Previous
                                </a>
                            </li>
                            {% endif %}

                            {% for p in page_range %}
                                {% if p == page %}
                                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                {% elif p >= page|add:"-3" and p <= page|add:"3" %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ p }}{% if search_query %}&search={{ search_query }}&search_type={{ search_type }}{% endif %}">
                                        {{ p }}
                                    </a>
                                </li>
                                {% elif p == 1 or p == total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ p }}{% if search_query %}&search={{ search_query }}&search_type={{ search_type }}{% endif %}">
                                        {{ p }}
                                    </a>
                                </li>
                                {% elif p == page|add:"-4" or p == page|add:"4" %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}

                            {% if has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page|add:"1" }}{% if search_query %}&search={{ search_query }}&search_type={{ search_type }}{% endif %}">
                                    Next &raquo;
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }

    .pagination .page-link {
        color: #0070C0;
    }

    .pagination .page-item.active .page-link {
        background-color: #0070C0;
        border-color: #0070C0;
        color: white;
    }

    /* Autocomplete styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: none;
    }

    .autocomplete-dropdown.show {
        display: block;
    }

    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
    }

    .autocomplete-item:hover {
        background-color: #f0f0f0;
    }

    .position-relative {
        position: relative;
    }
</style>

<script>
    // Handle autocomplete item selection
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'autocomplete-results') {
            const items = event.detail.target.querySelectorAll('.autocomplete-item');
            if (items.length > 0) {
                event.detail.target.classList.add('show');
            } else {
                event.detail.target.classList.remove('show');
            }
        }
    });

    // Handle clicking on autocomplete suggestions
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('autocomplete-item')) {
            const searchInput = document.getElementById('search-input');
            searchInput.value = event.target.textContent.trim();
            document.getElementById('autocomplete-results').classList.remove('show');
            document.getElementById('autocomplete-results').innerHTML = '';
        }
    });

    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(event) {
        const autocomplete = document.getElementById('autocomplete-results');
        const searchInput = document.getElementById('search-input');
        if (!searchInput.contains(event.target) && !autocomplete.contains(event.target)) {
            autocomplete.classList.remove('show');
        }
    });

    // Reset autocomplete when search type changes
    document.getElementById('search-type').addEventListener('change', function() {
        document.getElementById('autocomplete-results').innerHTML = '';
        document.getElementById('autocomplete-results').classList.remove('show');
    });
</script>
{% endblock %}
