{% extends 'core/base.html' %}
{% load static %}

{% block title %}MRQN - Quality Inspection - Cortex ERP{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 py-2">
    {% if messages %}
    <div class="mb-2">
        {% for message in messages %}
        <div class="bg-{{ message.tags }}-100 border border-{{ message.tags }}-400 text-{{ message.tags }}-700 px-2 py-1 rounded text-xs mb-1" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="bg-white rounded shadow">
        <div class="bg-gradient-to-r from-gray-700 to-gray-800 px-3 py-2 rounded-t">
            <h1 class="text-white font-semibold text-sm">Material Return Quality Note [MRQN] - New</h1>
        </div>

        <!-- MRN Information -->
        <div class="bg-white px-4 py-3 border-b border-gray-200">
            <table class="w-full text-xs">
                <tr>
                    <td class="w-16 py-1"><strong>MRN No:</strong></td>
                    <td class="w-24 py-1">{{ mrn_master.mrnno|default:"-" }}</td>
                    <td class="w-12 py-1"><strong>Date:</strong></td>
                    <td class="py-1">{{ mrn_master.sysdate|default:"-" }}</td>
                </tr>
            </table>
            <div class="mt-2 text-xs font-semibold text-blue-700">
                <strong>A:</strong> Total Returned Quantity, 
                <strong>B:</strong> Accepted Quantity, 
                <strong>C:</strong> Rejected Quantity.
            </div>
        </div>

        <!-- Quality Inspection Form -->
        <form method="post" id="mrqnForm">
            {% csrf_token %}
            <div class="p-2">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b border-gray-300">
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">SN</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">SELECT</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">ITEM CODE</th>
                                <th class="px-2 py-2 text-left text-[10px] font-semibold text-gray-700 border-r border-gray-300">DESCRIPTION</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">UOM</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">WO NO</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">A</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700 border-r border-gray-300">B</th>
                                <th class="px-2 py-2 text-center text-[10px] font-semibold text-gray-700">C</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detail in mrn_details %}
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200 text-right">{{ forloop.counter }}</td>
                                <td class="px-2 py-2 text-center border-r border-gray-200">
                                    <input type="checkbox" name="selected_{{ detail.id }}" id="ck_{{ detail.id }}" 
                                           onchange="toggleInputs({{ detail.id }})" class="h-4 w-4 text-sap-blue border-gray-300 rounded focus:ring-sap-blue">
                                    <input type="hidden" name="item_id" value="{{ detail.id }}">
                                </td>
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200 text-center">{{ detail.item_code }}</td>
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200">{{ detail.description }}</td>
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200 text-center">{{ detail.uom }}</td>
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200 text-center">{{ detail.wo_no|default:"-" }}</td>
                                <td class="px-2 py-2 text-[11px] text-gray-900 border-r border-gray-200 text-right">{{ detail.retqty|floatformat:3 }}</td>
                                <td class="px-2 py-2 border-r border-gray-200">
                                    <input type="number" name="accepted_qty_{{ detail.id }}" id="accepted_qty_{{ detail.id }}"
                                           step="0.001" min="0" value="0" class="w-16 px-1 py-1 text-xs border border-gray-300 rounded" 
                                           disabled onchange="calculateRejectedQty({{ detail.id }})">
                                </td>
                                <td class="px-2 py-2 text-right text-[11px]">
                                    <span id="rejected_qty_{{ detail.id }}">0.000</span>
                                    <input type="hidden" name="rejected_qty_{{ detail.id }}" id="rejected_qty_hidden_{{ detail.id }}" value="0">
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="px-6 py-12 text-center">
                                    <p class="text-base text-red-700 font-semibold">No data to display !</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="mt-4 flex gap-2">
                    <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded transition-colors"
                            onclick="return confirmationAdd()">
                        Add
                    </button>
                    <a href="{% url 'quality_control:mrqn-new' %}" 
                       class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white text-sm font-medium rounded transition-colors">
                        Cancel
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function toggleInputs(detailId) {
    const checkbox = document.getElementById('ck_' + detailId);
    const inputs = [
        'accepted_qty_' + detailId,
    ];

    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.disabled = !checkbox.checked;
            if (checkbox.checked) {
                input.focus();
            }
        }
    });

    // Calculate rejected quantity when inputs change
    if (checkbox.checked) {
        calculateRejectedQty(detailId);
    }
}

function calculateRejectedQty(detailId) {
    // Find the row containing this detail
    const checkbox = document.getElementById('ck_' + detailId);
    const row = checkbox.closest('tr');
    const returnedQtyCell = row.querySelector('td:nth-child(7)'); // Column A (returned qty)
    const returnedQty = parseFloat(returnedQtyCell.textContent) || 0;
    
    const acceptedQty = parseFloat(document.getElementById('accepted_qty_' + detailId).value) || 0;
    
    const rejectedQty = Math.max(0, returnedQty - acceptedQty);
    
    document.getElementById('rejected_qty_' + detailId).textContent = rejectedQty.toFixed(3);
    document.getElementById('rejected_qty_hidden_' + detailId).value = rejectedQty;
}

function confirmationAdd() {
    const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one item for quality inspection!');
        return false;
    }

    return confirm('Are you sure you want to create this MRQN?');
}
</script>
{% endblock %}
