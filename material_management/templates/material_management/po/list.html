{% extends 'core/base.html' %}

{% block title %}PO Dashboard{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-2">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-sm font-bold text-gray-900">Purchase Order (PO)</h1>
        <a href="{% url 'material_management:po-new' %}" class="inline-flex items-center justify-center gap-2 h-8 px-3 text-xs font-medium rounded bg-sap-blue text-white hover:bg-sap-blue-hover transition-colors">
            <i class="fas fa-plus"></i>
            New PO
        </a>
    </div>

    <!-- Search Section -->
    <div class="bg-white rounded border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search By</label>
                <select id="searchField" class="h-8 px-3 text-xs border border-gray-300 rounded focus:outline-none focus:border-sap-blue focus:ring-1 focus:ring-sap-blue w-full">
                    <option value="supplier">Supplier</option>
                    <option value="po_no">PO No</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Value</label>
                <input type="text" id="searchValue" placeholder="Enter search value..." 
                       class="h-8 px-3 text-xs border border-gray-300 rounded focus:outline-none focus:border-sap-blue focus:ring-1 focus:ring-sap-blue w-full">
            </div>
            <div class="flex items-end">
                <button onclick="searchPO()" class="inline-flex items-center justify-center gap-2 h-8 px-3 text-xs font-medium rounded bg-sap-blue text-white hover:bg-sap-blue-hover transition-colors w-full">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </div>
            <div class="flex items-end">
                <button onclick="clearSearch()" class="inline-flex items-center justify-center gap-2 h-8 px-3 text-xs font-medium rounded border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 transition-colors w-full">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- PO Table -->
    <div class="bg-white rounded border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full table-fixed divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="w-12 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">SN</th>
                        <th class="w-20 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Year</th>
                        <th class="w-16 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">PO No</th>
                        <th class="w-14 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">View</th>
                        <th class="w-24 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="w-20 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Time</th>
                        <th class="w-32 px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase truncate">Gen By</th>
                        <th class="w-40 px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase truncate">Supplier</th>
                        <th class="w-16 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Code</th>
                        <th class="w-20 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Checked</th>
                        <th class="w-20 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Approved</th>
                        <th class="w-20 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">Auth</th>
                    </tr>
                </thead>
                <tbody id="po-list-body" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="12" class="px-6 py-8 text-center">
                            <div class="text-gray-500">
                                <p class="text-sm font-medium mb-1">Loading...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Load all POs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPOs();
});

function loadPOs(field = '', value = '') {
    let url = '/material-management/api/po/list/';
    if (field && value) {
        url += `?field=${field}&value=${encodeURIComponent(value)}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayPOs(data.pos);
        })
        .catch(error => {
            console.error('Error loading POs:', error);
            displayPOs([]);
        });
}

function searchPO() {
    const field = document.getElementById('searchField').value;
    const value = document.getElementById('searchValue').value;
    
    if (!value.trim()) {
        loadPOs();
        return;
    }
    
    loadPOs(field, value);
}

function clearSearch() {
    document.getElementById('searchValue').value = '';
    loadPOs();
}

function displayPOs(pos) {
    const tbody = document.getElementById('po-list-body');
    
    if (!pos || pos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="px-6 py-8 text-center">
                    <div class="text-gray-500">
                        <p class="text-sm font-medium mb-1">No data to display!</p>
                        <p class="text-xs">Use the search above to find POs or click "New PO" to create one.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pos.map((po, index) => `
        <tr class="hover:bg-gray-50">
            <td class="px-2 py-2 text-xs text-center">${index + 1}</td>
            <td class="px-2 py-2 text-xs text-center truncate">${po.FinYear || '-'}</td>
            <td class="px-2 py-2 text-xs text-center font-medium">${po.PONo}</td>
            <td class="px-2 py-2 text-xs text-center">
                <a href="/material-management/po/${po.Id}/detail/" class="text-blue-600 hover:text-blue-900">View</a>
            </td>
            <td class="px-2 py-2 text-xs text-center">${po.Date || '-'}</td>
            <td class="px-2 py-2 text-xs text-center">${po.Time || '-'}</td>
            <td class="px-2 py-2 text-xs text-gray-900 truncate" title="${po.GenBy || '-'}">${po.GenBy || '-'}</td>
            <td class="px-2 py-2 text-xs text-gray-900 truncate" title="${po.Sup || '-'}">${po.Sup || '-'}</td>
            <td class="px-2 py-2 text-xs text-center">${po.Code || '-'}</td>
            <td class="px-2 py-2 text-xs text-center">${po.CheckedDate || '-'}</td>
            <td class="px-2 py-2 text-xs text-center">${po.ApprovedDate || '-'}</td>
            <td class="px-2 py-2 text-xs text-center">${po.AuthorizedDate || '-'}</td>
        </tr>
    `).join('');
}
</script>
{% endblock %}
