{% extends 'core/base.html' %}
{% load static %}

{% block title %}Rate Lock-Unlock - Material Management{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Page Header - Compact -->
    <div class="bg-white border-b border-gray-200 px-3 py-2">
        <h1 class="text-sm font-semibold text-gray-900">Rate Lock-Unlock</h1>
    </div>

    <!-- Search Form - Compact -->
    <div class="bg-white border-b border-gray-200 px-3 py-2">
        <form method="get" action="{% url 'material_management:rate_lock_unlock_list' %}" class="flex items-center gap-2 flex-wrap">
            <!-- Type Selection -->
            <div class="flex items-center gap-2">
                <label for="type" class="text-xs text-gray-700 whitespace-nowrap">Type:</label>
                <select name="type" id="type" class="h-8 px-3 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue" onchange="handleTypeChange(this.value)">
                    <option value="">Select</option>
                    <option value="Category" {% if search_type == 'Category' %}selected{% endif %}>Category</option>
                    <option value="WOItems" {% if search_type == 'WOItems' %}selected{% endif %}>WO Items</option>
                </select>
            </div>

            <!-- Category Selection -->
            <div id="category-div" class="flex items-center gap-2{% if search_type != 'Category' %} hidden{% endif %}"
                <label for="category" class="text-xs text-gray-700 whitespace-nowrap">Category:</label>
                <select name="category" id="category" class="h-8 px-3 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue w-64">
                    <option value="">Select</option>
                    {% for cat in categories %}
                    <option value="{{ cat.cid }}" {% if category_id == cat.cid|stringformat:"s" %}selected{% endif %}>
                        {{ cat.symbol }}-{{ cat.cname }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Search Field -->
            <div id="search-field-div" class="flex items-center gap-2{% if not search_type %} hidden{% endif %}"
                <label for="search_field" class="text-xs text-gray-700 whitespace-nowrap">Search By:</label>
                <select name="search_field" id="search_field" class="h-8 px-3 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue">
                    <option value="">Select</option>
                    <option value="ItemCode" {% if search_field == 'ItemCode' %}selected{% endif %}>Item Code</option>
                    <option value="Description" {% if search_field == 'Description' %}selected{% endif %}>Description</option>
                </select>
            </div>

            <!-- Search Text -->
            <div id="search-text-div" class="flex items-center gap-2{% if not search_type %} hidden{% endif %}"
                <input type="text" name="search_text" id="search_text" value="{{ search_text }}" 
                       class="h-8 px-3 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue w-48"
                       placeholder="Search text">
            </div>

            <button type="submit" class="h-8 px-3 text-xs bg-sap-blue text-white rounded hover:bg-sap-blue-hover transition-colors">
                Search
            </button>
        </form>
    </div>

    <!-- Results Table - Full Height -->
    {% if items %}
    <div class="flex-1 bg-white border-t border-gray-200 overflow-hidden flex flex-col">
        <div class="flex-1 overflow-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50 sticky top-0">
                    <tr class="border-b border-gray-200">
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 w-12">SN</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700">Item Code</th>
                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700">Description</th>
                        <th scope="col" class="px-3 py-2 text-center text-xs font-medium text-gray-700 w-16">UOM</th>
                        <th scope="col" class="px-3 py-2 text-center text-xs font-medium text-gray-700 w-48">Unlock For</th>
                        <th scope="col" class="px-3 py-2 text-center text-xs font-medium text-gray-700 w-20">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for item in items %}
                    <tr class="h-8 border-b border-gray-100 hover:bg-blue-50/30">
                        <td class="px-3 py-2 text-xs text-gray-900 text-right">
                            {{ forloop.counter|add:page_obj.start_index|add:"-1" }}
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900">
                            {{ item.itemcode }}
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900">
                            {{ item.manfdesc }}
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900 text-center">
                            {{ item.uombasic }}
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-900 text-center">
                            <form method="post" action="{% url 'material_management:rate_lock_unlock_action' %}" id="form-{{ item.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="item_id" value="{{ item.id }}">
                                <input type="hidden" name="lock_id" value="{{ item.lock_id }}">
                                
                                {% if item.lock_status == 1 %}
                                    <!-- Locked - show selected type -->
                                    <div class="flex items-center justify-center gap-2">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="0" {% if item.lock_type == 0 %}checked{% endif %} disabled class="w-3 h-3">
                                            <span class="ml-1 text-xs">PR</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="1" {% if item.lock_type == 1 %}checked{% endif %} disabled class="w-3 h-3">
                                            <span class="ml-1 text-xs">SPR</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="2" {% if item.lock_type == 2 %}checked{% endif %} disabled class="w-3 h-3">
                                            <span class="ml-1 text-xs">PO</span>
                                        </label>
                                    </div>
                                {% else %}
                                    <!-- Unlocked - show radio buttons -->
                                    <div class="flex items-center justify-center gap-2">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="0" class="w-3 h-3">
                                            <span class="ml-1 text-xs">PR</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="1" class="w-3 h-3">
                                            <span class="ml-1 text-xs">SPR</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="lock_type" value="2" class="w-3 h-3">
                                            <span class="ml-1 text-xs">PO</span>
                                        </label>
                                    </div>
                                {% endif %}
                            </form>
                        </td>
                        <td class="px-3 py-2 text-xs text-center">
                            {% if item.lock_status == 1 %}
                                <button type="button" onclick="confirmUnlock('{{ item.id }}')" 
                                        class="text-sap-red hover:text-red-700 font-medium">
                                    Unlock
                                </button>
                            {% else %}
                                <button type="button" onclick="confirmLock('{{ item.id }}')" 
                                        class="text-sap-green hover:text-green-700 font-medium">
                                    Lock
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination - Compact -->
        {% if is_paginated %}
        <div class="bg-white px-3 py-2 flex items-center justify-between border-t border-gray-200">
            <p class="text-xs text-gray-700">
                Showing <span class="font-medium">{{ page_obj.start_index }}</span> to <span class="font-medium">{{ page_obj.end_index }}</span> of <span class="font-medium">{{ page_obj.paginator.count }}</span> results
            </p>
            <nav class="flex items-center gap-1">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&type={{ search_type }}&category={{ category_id }}&search_field={{ search_field }}&search_text={{ search_text }}" 
                   class="h-8 px-3 text-xs border border-gray-300 bg-white text-gray-700 rounded hover:bg-gray-50 flex items-center">
                    Previous
                </a>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="h-8 px-3 flex items-center text-xs border border-sap-blue bg-sap-blue text-white rounded">
                        {{ num }}
                    </span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}&type={{ search_type }}&category={{ category_id }}&search_field={{ search_field }}&search_text={{ search_text }}" 
                       class="h-8 px-3 flex items-center text-xs border border-gray-300 bg-white text-gray-700 rounded hover:bg-gray-50">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&type={{ search_type }}&category={{ category_id }}&search_field={{ search_field }}&search_text={{ search_text }}" 
                   class="h-8 px-3 text-xs border border-gray-300 bg-white text-gray-700 rounded hover:bg-gray-50 flex items-center">
                    Next
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>
    {% elif search_type %}
    <div class="flex-1 flex items-center justify-center bg-gray-50">
        <p class="text-xs text-gray-500">No items found matching your search criteria.</p>
    </div>
    {% endif %}
</div>

<script>
function handleTypeChange(value) {
    const categoryDiv = document.getElementById('category-div');
    const searchFieldDiv = document.getElementById('search-field-div');
    const searchTextDiv = document.getElementById('search-text-div');
    
    if (value === 'Category') {
        categoryDiv.style.display = 'flex';
        searchFieldDiv.style.display = 'flex';
        searchTextDiv.style.display = 'flex';
    } else if (value === 'WOItems') {
        categoryDiv.style.display = 'none';
        searchFieldDiv.style.display = 'flex';
        searchTextDiv.style.display = 'flex';
    } else {
        categoryDiv.style.display = 'none';
        searchFieldDiv.style.display = 'none';
        searchTextDiv.style.display = 'none';
    }
}

function confirmLock(itemId) {
    const form = document.getElementById('form-' + itemId);
    const lockType = form.querySelector('input[name="lock_type"]:checked');
    
    if (!lockType) {
        alert('Please select unlock type (PR/SPR/PO)');
        return false;
    }
    
    if (confirm('Are you sure you want to unlock this item rate?')) {
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'lock';
        form.appendChild(actionInput);
        form.submit();
    }
}

function confirmUnlock(itemId) {
    if (confirm('Are you sure you want to lock this item rate?')) {
        const form = document.getElementById('form-' + itemId);
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'unlock';
        form.appendChild(actionInput);
        form.submit();
    }
}
</script>
{% endblock %}
