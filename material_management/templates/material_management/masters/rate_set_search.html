{% extends 'core/base.html' %}
{% load static %}

{% block title %}Rate Register{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-4">
    <!-- Header -->
    <div class="bg-gradient-to-r from-gray-700 to-gray-600 px-4 py-2 rounded-t">
        <h2 class="text-white font-bold text-base">Rate Register</h2>
    </div>

    <!-- Search Form -->
    <div class="bg-white border border-gray-300 rounded-b p-4">
        <form method="get" id="searchForm" class="space-y-3">
            <div class="flex items-center gap-3">
                <!-- Type Dropdown -->
                <select name="search_type" id="drpType" class="px-3 py-2 border border-gray-300 rounded text-sm"
                        onchange="handleTypeChange()">
                    <option value="Select">Select</option>
                    <option value="Category" {% if search_type == 'Category' %}selected{% endif %}>Category</option>
                    <option value="WOItems" {% if search_type == 'WOItems' %}selected{% endif %}>WO Items</option>
                </select>

                <!-- Category Dropdown (shown when Type = Category) -->
                <select name="category_id" id="drpCategory" class="px-3 py-2 border border-gray-300 rounded text-sm w-56{% if search_type != 'Category' %} hidden{% endif %}"
                        onchange="this.form.submit()">
                    <option value="Select">Select</option>
                    {% for category in categories %}
                    <option value="{{ category.cid }}" {% if category_id|stringformat:"s" == category.cid|stringformat:"s" %}selected{% endif %}>
                        {{ category.symbol }}-{{ category.cname }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Search Field Dropdown -->
                <select name="search_field" id="drpSearchField" class="px-3 py-2 border border-gray-300 rounded text-sm w-48"
                        style="display: {% if search_type in 'Category,WOItems' and search_type != 'Select' %}inline-block{% else %}none{% endif %};"
                        onchange="handleSearchFieldChange()">
                    <option value="Select">Select</option>
                    <option value="ItemCode" {% if search_field == 'ItemCode' %}selected{% endif %}>Item Code</option>
                    <option value="ManfDesc" {% if search_field == 'ManfDesc' %}selected{% endif %}>Description</option>
                    <option value="Location" {% if search_field == 'Location' %}selected{% endif %}>Location</option>
                </select>

                <!-- Location Dropdown (shown when search_field = Location) -->
                <select name="location" id="drpLocation" class="px-3 py-2 border border-gray-300 rounded text-sm w-40"
                        style="display: {% if search_field == 'Location' %}inline-block{% else %}none{% endif %};"
                        onchange="this.form.submit()">
                    <option value="Select">Select</option>
                    {% for loc in locations %}
                    <option value="{{ loc }}" {% if location == loc %}selected{% endif %}>{{ loc }}</option>
                    {% endfor %}
                </select>

                <!-- Search Text Input (shown for ItemCode/Description) -->
                <input type="text" name="search_value" id="txtSearch" value="{{ search_value }}"
                       class="px-3 py-2 border border-gray-300 rounded text-sm w-52"
                       placeholder="Search..."
                       style="display: {% if search_field in 'ItemCode,ManfDesc' %}inline-block{% else %}none{% endif %};">

                <!-- Search Button -->
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-semibold"
                        style="display: {% if search_type != 'Select' %}inline-block{% else %}none{% endif %};">
                    Search
                </button>
            </div>
        </form>

        <!-- Results Grid -->
        {% if items %}
        <div class="mt-4 overflow-x-auto">
            <table class="w-full border-collapse text-xs">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border border-gray-300 px-2 py-1"></th>
                        <th class="border border-gray-300 px-2 py-1 text-center">SN</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Category</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">ItemCode</th>
                        <th class="border border-gray-300 px-2 py-1">Manf Desc</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">UOM</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Stock Qty</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Location</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Excise</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Import/Local</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Open Bal Date</th>
                        <th class="border border-gray-300 px-2 py-1 text-center">Opening Bal Qty</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-2 py-1 text-center">
                            <a href="{% url 'material_management:rate-set-details' %}?item_id={{ item.id }}"
                               class="text-blue-600 hover:text-blue-800 underline">Select</a>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ forloop.counter }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">
                            {% if item.cid %}{{ item.cid.symbol }}-{{ item.cid.cname }}{% else %}-{% endif %}
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.itemcode|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1">{{ item.manfdesc|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.uombasic_symbol|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ item.stockqty|default:'0' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.location|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.excise|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.importlocal|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-center">{{ item.openingbaldate|default:'-' }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ item.openingbalqty|default:'0' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="mt-4 flex justify-center gap-2">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1"
                   class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">First</a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                   class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">Previous</a>
                {% endif %}

                <span class="px-3 py-1">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

                {% if page_obj.has_next %}
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                   class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">Next</a>
                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}"
                   class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">Last</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% elif search_type != 'Select' %}
        <div class="mt-4 text-center text-gray-500 text-lg">
            No data to display!
        </div>
        {% endif %}
    </div>
</div>

<script>
function handleTypeChange() {
    const searchType = document.getElementById('drpType').value;
    const categoryDropdown = document.getElementById('drpCategory');
    const searchFieldDropdown = document.getElementById('drpSearchField');
    const locationDropdown = document.getElementById('drpLocation');
    const searchInput = document.getElementById('txtSearch');

    if (searchType === 'Category') {
        categoryDropdown.style.display = 'inline-block';
        searchFieldDropdown.style.display = 'inline-block';
    } else if (searchType === 'WOItems') {
        categoryDropdown.style.display = 'none';
        searchFieldDropdown.style.display = 'inline-block';
        locationDropdown.style.display = 'none';
        searchInput.style.display = 'inline-block';
    } else {
        // Reset form when "Select" is chosen
        window.location.href = '{% url "material_management:rate-set-search" %}';
    }
}

function handleSearchFieldChange() {
    const searchField = document.getElementById('drpSearchField').value;
    const locationDropdown = document.getElementById('drpLocation');
    const searchInput = document.getElementById('txtSearch');

    if (searchField === 'Location') {
        locationDropdown.style.display = 'inline-block';
        searchInput.style.display = 'none';
    } else if (searchField === 'ItemCode' || searchField === 'ManfDesc') {
        locationDropdown.style.display = 'none';
        searchInput.style.display = 'inline-block';
    } else {
        locationDropdown.style.display = 'none';
        searchInput.style.display = 'inline-block';
    }
}
</script>
{% endblock %}
