{% extends 'core/base.html' %}
{% load static %}

{% block title %}New Purchase Requisition - WO {{ wo_no }} - Cortex ERP{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header - Compact SAP Fiori Style -->
    <div class="bg-white border-b border-gray-200 px-3 py-2 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="text-sm font-semibold text-gray-900">PR - New</h1>
            <span class="text-xs text-gray-600">WO No: <strong>{{ wo_no }}</strong></span>
            {% if wo_mfg_date %}
            <span class="text-xs text-gray-600">Required Date: <strong>{{ wo_mfg_date|date:"d-m-Y" }}</strong></span>
            {% endif %}
        </div>
        <div class="flex items-center gap-2">
            <a href="{% url 'material_management:pr-list' %}" 
               class="h-8 px-3 text-xs border border-gray-300 text-gray-700 bg-white rounded hover:bg-gray-50 flex items-center">
                Back to List
            </a>
        </div>
    </div>

    <!-- Main Content - Scrollable Table -->
    <div class="flex-1 bg-white overflow-auto">
        {% if items %}
        <form method="post" id="prForm">
            {% csrf_token %}
            <input type="hidden" name="wo_no" value="{{ wo_no }}">
            <input type="hidden" name="action" value="generate_pr_bulk">
            
            <table class="min-w-full">
                <thead class="bg-gray-50 sticky top-0">
                    <tr class="border-b border-gray-200">
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 w-12">SN</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 w-24">Item Code</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 w-48">Description</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 w-16">UOM</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 w-20">BOM Qty</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 w-20">SHORTAGE Qty</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 w-16">Add</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for item in items %}
                    <tr class="border-b border-gray-100">
                        <td class="px-3 py-2 text-xs text-right align-top">{{ forloop.counter }}</td>
                        <td class="px-3 py-2 text-xs align-top">{{ item.ItemCode }}</td>
                        <td class="px-3 py-2 text-xs align-top">{{ item.ManfDesc }}</td>
                        <td class="px-3 py-2 text-xs text-center align-top">{{ item.UOMBasic }}</td>
                        <td class="px-3 py-2 text-xs text-right align-top">{{ item.BOMQty|floatformat:3 }}</td>
                        <td class="px-3 py-2 text-xs text-right align-top font-semibold text-sap-blue">
                            {{ item.ReqQty|floatformat:3 }}
                        </td>
                        <td class="px-3 py-2 text-xs text-center align-top">
                            <button type="button" 
                                    onclick="addSupplierRow({{ item.ItemId }}, '{{ item.ItemCode }}')"
                                    class="text-sap-blue hover:text-sap-blue-hover font-medium">
                                Add
                            </button>
                        </td>
                    </tr>
                    <!-- Nested Supplier Grid (Initially Hidden) -->
                    <tr id="supplier-grid-{{ item.ItemId }}" style="display:none;">
                        <td colspan="7" class="px-3 py-2 bg-gray-50">
                            <table class="w-full border border-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-1 text-xs font-medium text-gray-700 w-8">Del</th>
                                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-700 w-48">Supplier</th>
                                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-700 w-20">Qty</th>
                                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-700 w-20">Rate</th>
                                        <th class="px-2 py-1 text-right text-xs font-medium text-gray-700 w-16">Discount</th>
                                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-700 w-24">Delivery Date</th>
                                    </tr>
                                </thead>
                                <tbody id="supplier-rows-{{ item.ItemId }}">
                                    <!-- Supplier rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        {% else %}
        <div class="flex-1 flex items-center justify-center bg-gray-50">
            <p class="text-xs text-gray-500">No items found for this Work Order.</p>
        </div>
        {% endif %}
    </div>

    <!-- Footer Actions -->
    {% if items %}
    <div class="bg-white border-t border-gray-200 px-3 py-2 flex justify-center gap-2">
        <button type="button" 
                onclick="generatePR()"
                class="h-8 px-4 text-xs bg-sap-blue text-white rounded hover:bg-sap-blue-hover transition-colors">
            Generate PR
        </button>
        <a href="{% url 'material_management:pr-new-search' %}" 
           class="h-8 px-4 text-xs border border-gray-300 text-gray-700 bg-white rounded hover:bg-gray-50 flex items-center">
            Cancel
        </a>
    </div>
    {% endif %}
</div>

<!-- Supplier Autocomplete Data -->
<script>
const suppliers = {{ suppliers|safe }};
let supplierRowCounter = 0;

function addSupplierRow(itemId, itemCode) {
    const grid = document.getElementById('supplier-grid-' + itemId);
    const tbody = document.getElementById('supplier-rows-' + itemId);
    
    // Show the grid if hidden
    grid.style.display = '';
    
    // Create new row
    const rowId = 'supplier-row-' + (++supplierRowCounter);
    const row = document.createElement('tr');
    row.id = rowId;
    row.className = 'border-b border-gray-100';
    row.innerHTML = `
        <td class="px-2 py-1 text-center">
            <button type="button" onclick="deleteSupplierRow('${rowId}')" 
                    class="text-sap-red hover:text-red-700">
                âœ•
            </button>
        </td>
        <td class="px-2 py-1">
            <input type="text" 
                   name="supplier_${itemId}[]" 
                   class="w-full h-7 px-2 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue"
                   placeholder="Enter supplier name"
                   list="supplier-list-${itemId}"
                   required>
            <datalist id="supplier-list-${itemId}">
                ${suppliers.map(s => `<option value="${s.supplier_name}">`).join('')}
            </datalist>
        </td>
        <td class="px-2 py-1">
            <input type="number" 
                   name="qty_${itemId}[]" 
                   step="0.001"
                   class="w-full h-7 px-2 text-xs border border-gray-300 rounded text-right focus:border-sap-blue focus:ring-1 focus:ring-sap-blue"
                   placeholder="0.000"
                   required>
        </td>
        <td class="px-2 py-1">
            <input type="number" 
                   name="rate_${itemId}[]" 
                   step="0.01"
                   class="w-full h-7 px-2 text-xs border border-gray-300 rounded text-right focus:border-sap-blue focus:ring-1 focus:ring-sap-blue"
                   placeholder="0.00"
                   required>
        </td>
        <td class="px-2 py-1">
            <input type="number" 
                   name="discount_${itemId}[]" 
                   step="0.01"
                   value="0"
                   class="w-full h-7 px-2 text-xs border border-gray-300 rounded text-right focus:border-sap-blue focus:ring-1 focus:ring-sap-blue"
                   placeholder="0.00">
        </td>
        <td class="px-2 py-1">
            <input type="date" 
                   name="delivery_date_${itemId}[]" 
                   class="w-full h-7 px-2 text-xs border border-gray-300 rounded focus:border-sap-blue focus:ring-1 focus:ring-sap-blue"
                   required>
        </td>
    `;
    
    tbody.appendChild(row);
}

function deleteSupplierRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        row.remove();
    }
}

function generatePR() {
    const form = document.getElementById('prForm');
    
    // Collect all supplier data from nested grids
    const itemsData = [];
    const supplierGrids = document.querySelectorAll('[id^="supplier-rows-"]');
    
    supplierGrids.forEach(grid => {
        const itemId = grid.id.replace('supplier-rows-', '');
        const rows = grid.querySelectorAll('tr');
        
        rows.forEach(row => {
            const supplierInput = row.querySelector(`input[name="supplier_${itemId}[]"]`);
            const qtyInput = row.querySelector(`input[name="qty_${itemId}[]"]`);
            const rateInput = row.querySelector(`input[name="rate_${itemId}[]"]`);
            const discountInput = row.querySelector(`input[name="discount_${itemId}[]"]`);
            const deliveryDateInput = row.querySelector(`input[name="delivery_date_${itemId}[]"]`);
            
            if (supplierInput && qtyInput && rateInput) {
                itemsData.push({
                    item_id: itemId,
                    supplier: supplierInput.value,
                    qty: parseFloat(qtyInput.value) || 0,
                    rate: parseFloat(rateInput.value) || 0,
                    discount: parseFloat(discountInput.value) || 0,
                    delivery_date: deliveryDateInput.value
                });
            }
        });
    });
    
    if (itemsData.length === 0) {
        alert('Please add at least one supplier for at least one item.');
        return;
    }

    // VALIDATION: Check if all items have suppliers assigned (prevent orphaned PR details)
    const itemsWithoutSupplier = itemsData.filter(item => !item.supplier || item.supplier.trim() === '');
    if (itemsWithoutSupplier.length > 0) {
        alert(`ERROR: ${itemsWithoutSupplier.length} item(s) do not have suppliers assigned.\n\nAll items must have a supplier before generating PR.\n\nPlease add suppliers to all items.`);
        return;
    }

    // Validate form
    if (form.checkValidity()) {
        if (confirm('Generate Purchase Requisition?')) {
            // Add items data as JSON to form
            const itemsDataInput = document.createElement('input');
            itemsDataInput.type = 'hidden';
            itemsDataInput.name = 'items_data';
            itemsDataInput.value = JSON.stringify(itemsData);
            form.appendChild(itemsDataInput);
            
            form.submit();
        }
    } else {
        form.reportValidity();
    }
}
</script>
{% endblock %}
