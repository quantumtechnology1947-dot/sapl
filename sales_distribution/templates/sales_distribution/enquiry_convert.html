{% extends "core/base.html" %}

{% block title %}Enquiry Convert to Customer - Cortex ERP{% endblock %}
{% block page_title %}Enquiry Convert to Customer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded border border-gray-200 p-3 mb-4">
        <div class="flex items-center justify-between gap-4">
            <div>
                <h2 class="text-sm font-semibold text-gray-800">Enquiry Convert to Customer</h2>
                <p class="text-xs text-gray-600 mt-1">Search and convert enquiries to customers</p>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="bg-white rounded border border-gray-200 p-4 mb-4">
        <form method="get" class="flex items-end gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Search By</label>
                <select name="search_type" id="search_type" onchange="toggleSearchFields()" class="w-48 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="select" {% if search_type == "select" %}selected{% endif %}>Select</option>
                    <option value="customer_name" {% if search_type == "customer_name" %}selected{% endif %}>Customer Name</option>
                    <option value="enq_no" {% if search_type == "enq_no" %}selected{% endif %}>Enquiry No</option>
                </select>
            </div>

            <div class="flex-1 {% if search_type != 'customer_name' %}hidden{% endif %}" id="search_value_div">
                <label class="block text-xs font-medium text-gray-700 mb-1">Customer Name</label>
                <input type="text"
                       name="search_value"
                       id="search_value"
                       value="{{ search_value }}"
                       placeholder="Enter customer name..."
                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex-1 {% if search_type != 'enq_no' %}hidden{% endif %}" id="enq_id_div">
                <label class="block text-xs font-medium text-gray-700 mb-1">Enquiry No</label>
                <input type="number"
                       name="enq_id"
                       id="enq_id"
                       value="{{ enq_id }}"
                       placeholder="Enter enquiry number..."
                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                Search
            </button>

            <a href="{% url 'sales_distribution:enquiry-convert' %}"
               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-md text-sm font-medium transition-colors">
                Clear
            </a>
        </form>
    </div>

<script>
function toggleSearchFields() {
    const searchType = document.getElementById('search_type').value;
    const searchValueDiv = document.getElementById('search_value_div');
    const enqIdDiv = document.getElementById('enq_id_div');

    if (searchType === 'customer_name') {
        searchValueDiv.classList.remove('hidden');
        enqIdDiv.classList.add('hidden');
    } else if (searchType === 'enq_no') {
        searchValueDiv.classList.add('hidden');
        enqIdDiv.classList.remove('hidden');
    } else {
        searchValueDiv.classList.add('hidden');
        enqIdDiv.classList.add('hidden');
    }
}
</script>

    <!-- Results Table -->
    {% if enquiries %}
    <div class="bg-white rounded border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full divide-y divide-gray-200 text-xs">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="w-[4%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">SN</th>
                        <th class="w-[6%] px-2 py-2 text-center text-[10px] font-medium text-gray-500 uppercase">CK</th>
                        <th class="w-[10%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Enq No</th>
                        <th class="w-[15%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Fin Yrs</th>
                        <th class="w-[35%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Customer Name</th>
                        <th class="w-[15%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Gen Date</th>
                        <th class="w-[15%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Gen By</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in enquiries %}
                    <tr id="enquiry-{{ item.enquiry.enqid }}" class="hover:bg-gray-50">
                        <td class="px-2 py-2 text-xs text-gray-900">{{ forloop.counter }}</td>
                        <td class="px-2 py-2 text-xs text-center">
                            <form method="post" class="inline" id="form-{{ item.enquiry.enqid }}" onsubmit="return confirm('Convert enquiry #{{ item.enquiry.enqid }} to customer?\n\nCustomer: {{ item.enquiry.customername }}\n\nThis will generate a new customer ID and create a customer record.');">
                                {% csrf_token %}
                                <input type="hidden" name="enq_id" value="{{ item.enquiry.enqid }}">
                                <input type="checkbox"
                                       name="convert"
                                       value="1"
                                       onchange="this.form.submit()"
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            </form>
                        </td>
                        <td class="px-2 py-2 text-xs font-medium text-gray-900">{{ item.enquiry.enqid }}</td>
                        <td class="px-2 py-2 text-xs text-gray-600">{{ item.finyear_name }}</td>
                        <td class="px-2 py-2 text-xs text-gray-900">
                            <a href="{% url 'sales_distribution:enquiry-detail' item.enquiry.enqid %}"
                               class="text-blue-600 hover:text-blue-800 hover:underline"
                               title="{{ item.enquiry.customername }}">
                                {{ item.enquiry.customername|default:"-" }}
                            </a>
                        </td>
                        <td class="px-2 py-2 text-xs text-gray-600">{{ item.enquiry.sysdate }}</td>
                        <td class="px-2 py-2 text-xs text-gray-600">{{ item.employee_name|truncatechars:20 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif search_type != "select" and search_value or enq_id %}
    <!-- No Results Message -->
    <div class="bg-white rounded border border-gray-200 p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No unconverted enquiries found</h3>
        <p class="mt-1 text-sm text-gray-500">Try adjusting your search criteria or check if the enquiry has already been converted.</p>
        <div class="mt-4">
            <a href="{% url 'sales_distribution:enquiry-list' %}"
               class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                View All Enquiries
            </a>
        </div>
    </div>
    {% else %}
    <!-- Initial State Message -->
    <div class="bg-white rounded border border-gray-200 p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">Search for unconverted enquiries</h3>
        <p class="mt-1 text-sm text-gray-500">Select a search criteria and enter a value to find enquiries that can be converted to customers.</p>
        <div class="mt-4 p-4 bg-blue-50 rounded-md text-left max-w-md mx-auto">
            <h4 class="text-xs font-semibold text-blue-900 mb-2">About Enquiry Conversion:</h4>
            <ul class="text-xs text-blue-800 space-y-1">
                <li>• Only unconverted enquiries (Flag=0) can be converted</li>
                <li>• Customer ID is generated based on first letter of name (e.g., T001 for TATA)</li>
                <li>• All address details are copied to the new customer record</li>
                <li>• Once converted, the enquiry is linked to the customer ID</li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}








