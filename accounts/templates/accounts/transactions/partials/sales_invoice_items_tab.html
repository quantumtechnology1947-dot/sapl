<!-- Goods/Items Tab Content matching ASP.NET layout -->
<div class="space-y-4">
    <!-- Items Grid Table -->
    <div class="overflow-x-auto">
        {{ goods_formset.management_form }}

        <table class="w-full border-collapse border border-gray-300 text-sm">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-2 py-1 text-left">SN</th>
                    <th class="border border-gray-300 px-2 py-1 text-center">Select</th>
                    <th class="border border-gray-300 px-2 py-1 text-left">Description</th>
                    <th class="border border-gray-300 px-2 py-1 text-left">Unit</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Total Qty</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Rem Qty</th>
                    <th class="border border-gray-300 px-2 py-1 text-left">Unit Of Qty</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Req Qty</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Rate</th>
                    <th class="border border-gray-300 px-2 py-1 text-right">Amt in (%)</th>
                </tr>
            </thead>
            <tbody id="items-table-body">
                {% for form in goods_formset %}
                <tr class="invoice-item-row hover:bg-gray-50" data-form-index="{{ forloop.counter0 }}">
                    <td class="border border-gray-300 px-2 py-1">{{ forloop.counter }}</td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        {{ form.selected }}
                        {{ form.item_id }}
                        {{ form.po_id }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.description }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.unit_symbol }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-right">
                        {{ form.total_qty }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-right font-semibold text-blue-600">
                        {{ form.remaining_qty }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.unit_of_qty }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.req_qty }}
                        {% if form.req_qty.errors %}
                            <div class="text-red-600 text-xs mt-1">{{ form.req_qty.errors.0 }}</div>
                        {% endif %}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.rate }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        {{ form.amt_in_percent }}
                        {% if form.amt_in_percent.errors %}
                            <div class="text-red-600 text-xs mt-1">{{ form.amt_in_percent.errors.0 }}</div>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="border border-gray-300 px-2 py-2 text-center text-gray-500">
                        No items available for this PO
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Formset errors -->
    {% if goods_formset.non_form_errors %}
        <div class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded mt-4">
            {{ goods_formset.non_form_errors }}
        </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center mt-6">
        <div class="text-sm text-gray-500">
            Step 3 of 4: Goods/Items Selection
        </div>
        <div class="flex gap-3">
            <button type="button" data-prev-tab="consignee" class="btn-prev-tab px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-medium shadow">
                ← Previous
            </button>
            <button type="button" data-next-tab="taxation" class="btn-next-tab px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium shadow">
                Next →
            </button>
        </div>
    </div>
</div>

<script>
// Items tab - Enable/disable inputs based on checkbox selection
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.invoice-item-row');
    
    rows.forEach(row => {
        const formIndex = row.getAttribute('data-form-index');
        const checkbox = document.getElementById(`id_form-${formIndex}-selected`);
        const reqQtyInput = document.getElementById(`id_form-${formIndex}-req_qty`);
        const percentInput = document.getElementById(`id_form-${formIndex}-amt_in_percent`);
        
        if (!checkbox || !reqQtyInput || !percentInput) return;
        
        // Function to toggle inputs
        function toggleInputs() {
            const isChecked = checkbox.checked;
            reqQtyInput.disabled = !isChecked;
            percentInput.disabled = !isChecked;
            
            if (!isChecked) {
                reqQtyInput.value = '';
                percentInput.value = '';
            }
            
            // Trigger calculation update
            updateTaxationCalculations();
        }
        
        // Initialize state
        toggleInputs();
        
        // Listen for changes
        checkbox.addEventListener('change', toggleInputs);
        reqQtyInput.addEventListener('input', updateTaxationCalculations);
        percentInput.addEventListener('input', updateTaxationCalculations);
    });
});

// Global function to update taxation calculations
function updateTaxationCalculations() {
    // Dispatch custom event that taxation tab will listen to
    const event = new CustomEvent('itemsChanged');
    document.dispatchEvent(event);
}
</script>
