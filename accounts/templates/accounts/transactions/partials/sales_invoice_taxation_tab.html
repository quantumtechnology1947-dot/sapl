<!-- Taxation Tab Content matching ASP.NET layout -->
<div class="space-y-4">
    <!-- CGST/IGST Dropdown -->
    <div class="grid grid-cols-12 gap-4">
        <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">CGST/IGST <span class="text-red-600">*</span></label>
        </div>
        <div class="col-span-4">
            {{ taxation_form.cenvat }}
        </div>
    </div>

    <!-- VAT/SGST Rate -->
    <div class="grid grid-cols-12 gap-4">
        <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">VAT/SGST Rate</label>
        </div>
        <div class="col-span-4">
            {{ taxation_form.vat }}
        </div>
    </div>

    <!-- CST Type (conditional based on invoice type) -->
    {% if show_cst %}
    <div class="grid grid-cols-12 gap-4">
        <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">CST Type</label>
        </div>
        <div class="col-span-4">
            {{ taxation_form.selectedcst }}
        </div>
    </div>
    {% endif %}

    <!-- Hidden fields for optional charges (defaulted to 0) -->
    {{ taxation_form.addtype }}
    {{ taxation_form.addamt }}
    {{ taxation_form.deductiontype }}
    {{ taxation_form.deduction }}
    {{ taxation_form.pftype }}
    {{ taxation_form.pf }}
    {{ taxation_form.sedtype }}
    {{ taxation_form.sed }}
    {{ taxation_form.aedtype }}
    {{ taxation_form.aed }}
    {{ taxation_form.freighttype }}
    {{ taxation_form.freight }}
    {{ taxation_form.insurancetype }}
    {{ taxation_form.insurance }}
    {{ taxation_form.otheramt }}
    {{ taxation_form.cst }}

    <!-- Totals Display (Right aligned) -->
    <div class="flex justify-end mt-6">
        <div class="w-1/3 bg-gray-50 border border-gray-300 rounded p-4">
            <div class="space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="font-medium">Subtotal:</span>
                    <span id="display-subtotal" class="font-mono font-semibold">₹ 0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="font-medium">CGST/IGST Amount:</span>
                    <span id="display-cenvat" class="font-mono">₹ 0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="font-medium">VAT/SGST Amount:</span>
                    <span id="display-vat" class="font-mono">₹ 0.00</span>
                </div>
                <div class="border-t border-gray-400 my-2"></div>
                <div class="flex justify-between text-base font-bold">
                    <span>Grand Total:</span>
                    <span id="display-grand-total" class="font-mono text-green-600">₹ 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between items-center mt-6">
        <div class="text-sm text-gray-500">
            Step 4 of 4: Taxation & Final Submission
        </div>
        <div class="flex gap-3">
            <button type="button" data-prev-tab="goods" class="btn-prev-tab px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-medium shadow">
                ← Previous
            </button>
            <button type="submit" name="action" value="save"
                    class="px-8 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium shadow flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Submit Invoice
            </button>
            <a href="{% url 'accounts:sales_invoice_po_selection' %}"
               class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium inline-block shadow">
                Cancel
            </a>
        </div>
    </div>
</div>

<script>
// Taxation tab - Automatic calculations
document.addEventListener('DOMContentLoaded', function() {
    const cenvatSelect = document.getElementById('id_cenvat');
    const vatSelect = document.getElementById('id_vat');

    // Extract tax rate from dropdown text (e.g., "CGST@9%" -> 9)
    function extractTaxRate(selectElement) {
        if (!selectElement || selectElement.selectedIndex <= 0) return 0;
        
        const selectedText = selectElement.options[selectElement.selectedIndex].text;
        const match = selectedText.match(/(\d+\.?\d*)/);
        return match ? parseFloat(match[1]) : 0;
    }

    // Calculate all totals
    function calculateTotals() {
        let subtotal = 0;
        
        // Get all checked items from goods tab
        const rows = document.querySelectorAll('.invoice-item-row');
        
        rows.forEach((row, index) => {
            const checkbox = document.getElementById(`id_form-${index}-selected`);
            if (!checkbox || !checkbox.checked) return;
            
            const qtyInput = document.getElementById(`id_form-${index}-req_qty`);
            const rateInput = document.getElementById(`id_form-${index}-rate`);
            
            if (qtyInput && rateInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                subtotal += qty * rate;
            }
        });
        
        // Get tax rates
        const cenvatRate = extractTaxRate(cenvatSelect);
        const vatRate = extractTaxRate(vatSelect);
        
        // Calculate tax amounts
        const cenvatAmount = (subtotal * cenvatRate) / 100;
        const vatAmount = (subtotal * vatRate) / 100;
        const grandTotal = subtotal + cenvatAmount + vatAmount;
        
        // Update display
        document.getElementById('display-subtotal').textContent = `₹ ${subtotal.toFixed(2)}`;
        document.getElementById('display-cenvat').textContent = `₹ ${cenvatAmount.toFixed(2)}`;
        document.getElementById('display-vat').textContent = `₹ ${vatAmount.toFixed(2)}`;
        document.getElementById('display-grand-total').textContent = `₹ ${grandTotal.toFixed(2)}`;
        
        console.log('Totals calculated:', { subtotal, cenvatAmount, vatAmount, grandTotal });
    }

    // Attach event listeners
    if (cenvatSelect) {
        cenvatSelect.addEventListener('change', calculateTotals);
    }
    
    if (vatSelect) {
        vatSelect.addEventListener('change', calculateTotals);
    }

    // Listen for changes from items tab
    document.addEventListener('itemsChanged', calculateTotals);

    // Initial calculation
    calculateTotals();
    
    // Also calculate when tab becomes visible
    const taxationTab = document.getElementById('tab-taxation');
    if (taxationTab) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!taxationTab.classList.contains('hidden')) {
                        setTimeout(calculateTotals, 100);
                    }
                }
            });
        });
        
        observer.observe(taxationTab, { attributes: true });
    }
});
</script>
