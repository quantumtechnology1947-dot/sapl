{% extends "core/base.html" %}
{% load static %}

{% block title %}Sales Invoice - New{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sales_invoice_calculations.js' %}"></script>
{% endblock %}

{% block page_title %}Sales Invoice - New{% endblock %}

{% block extra_head %}
<style>
[x-cloak] { display: none !important; }

/* Tab hiding - off-screen positioning (Playwright-compatible) */
.tab-panels {
    position: relative;
}

.tab-panel {
    /* Active tab - normal flow */
    position: relative;
}

.tab-panel.tab-hide {
    /* Hidden tabs - move off-screen but keep in DOM for Playwright */
    position: absolute;
    left: -99999px;
    top: auto;
    /* Elements off-screen are still accessible to Playwright with state:'attached' */
}

/* Tab button hover effects that can't be done with Tailwind alone */
.tab-button:hover:not(.active) {
    transform: translateY(-1px) !important;
}

.tab-button.active {
    transform: translateY(3px) !important;
    margin-bottom: -3px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="p-4 bg-gray-100">
    <!-- Header -->
    <div class="bg-gray-200 px-4 py-2 mb-4">
        <h2 class="text-lg font-semibold text-gray-800">Sales Invoice - New</h2>
    </div>

    <form method="post" id="salesInvoiceForm" class="bg-white p-4 border border-gray-300">
        {% csrf_token %}

        <!-- Invoice Header Section - 3 columns layout matching ASP.NET -->
        <div class="grid grid-cols-3 gap-x-8 gap-y-3 mb-4 pb-4 border-b border-gray-300">
            <!-- Column 1 -->
            <div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice No. :</label>
                    <input type="text" name="invoiceno" value="{{ next_invoice_no }}"
                           readonly class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PO No. :</label>
                    <input type="text" name="pono" value="{{ pono }}"
                           readonly class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    {{ header_form.customercategory }}
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mode of Transport</label>
                    {{ header_form.modeoftransport }}
                </div>
            </div>

            <!-- Column 2 -->
            <div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date :</label>
                    <input type="text" value="{{ current_date }}"
                           readonly class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PO Date :</label>
                    <input type="text" name="podate" value="{{ podate }}"
                           readonly class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Excisable Commodity</label>
                    {{ header_form.commodity }}
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Of Issue Of Invoice</label>
                    {{ header_form.dateofissueinvoice }}
                </div>
            </div>

            <!-- Column 3 -->
            <div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mode of Invoice :</label>
                    {{ header_form.invoicemode }}
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">WO No. :</label>
                    <input type="text" name="wono" value="{{ wono_display }}"
                           readonly class="w-full px-2 py-1 border border-gray-300 rounded bg-gray-100 text-sm">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tariff Head No/ Exemption Notif. No.</label>
                    {{ header_form.tariffheading }}
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Of Removal</label>
                    {{ header_form.dateofremoval }}
                </div>
            </div>
        </div>

        <!-- Hidden fields matching ASP.NET implementation -->
        {{ header_form.timeofissueinvoice }}
        {{ header_form.timeofremoval }}
        {{ header_form.natureofremoval }}
        {{ header_form.vehiregno }}
        {{ header_form.rrgcno }}
        {{ header_form.dutyrate }}

        <!-- Hidden fields for PO context -->
        <input type="hidden" name="po_id" value="{{ po_id }}">
        <input type="hidden" name="customer_id" value="{{ customer_id }}">
        <input type="hidden" name="work_order_ids" value="{{ work_order_ids }}">

        <!-- Tab Container -->
        <div class="mb-4">
            <!-- Tab Buttons -->
            <div class="flex gap-1 border-b-4 border-gray-200 mb-0 bg-gray-50 px-3 pt-3 rounded-t-lg">
                <button type="button" 
                        class="tab-button inline-flex items-center justify-center px-9 py-3.5 border-2 border-gray-300 border-b-0 bg-gradient-to-b from-gray-100 to-gray-200 cursor-pointer font-semibold text-sm text-gray-700 transition-all duration-200 rounded-t-lg relative whitespace-nowrap shadow-md tracking-wide uppercase min-w-[140px] hover:from-white hover:to-gray-100 hover:text-gray-900 hover:border-gray-400 hover:shadow-lg active" 
                        data-tab="buyer" 
                        id="btn-buyer">
                    Buyer
                </button>
                <button type="button" 
                        class="tab-button inline-flex items-center justify-center px-9 py-3.5 border-2 border-gray-300 border-b-0 bg-gradient-to-b from-gray-100 to-gray-200 cursor-pointer font-semibold text-sm text-gray-700 transition-all duration-200 rounded-t-lg relative whitespace-nowrap shadow-md tracking-wide uppercase min-w-[140px] hover:from-white hover:to-gray-100 hover:text-gray-900 hover:border-gray-400 hover:shadow-lg" 
                        data-tab="consignee" 
                        id="btn-consignee">
                    Consignee
                </button>
                <button type="button" 
                        class="tab-button inline-flex items-center justify-center px-9 py-3.5 border-2 border-gray-300 border-b-0 bg-gradient-to-b from-gray-100 to-gray-200 cursor-pointer font-semibold text-sm text-gray-700 transition-all duration-200 rounded-t-lg relative whitespace-nowrap shadow-md tracking-wide uppercase min-w-[140px] hover:from-white hover:to-gray-100 hover:text-gray-900 hover:border-gray-400 hover:shadow-lg" 
                        data-tab="goods" 
                        id="btn-goods">
                    Goods
                </button>
                <button type="button" 
                        class="tab-button inline-flex items-center justify-center px-9 py-3.5 border-2 border-gray-300 border-b-0 bg-gradient-to-b from-gray-100 to-gray-200 cursor-pointer font-semibold text-sm text-gray-700 transition-all duration-200 rounded-t-lg relative whitespace-nowrap shadow-md tracking-wide uppercase min-w-[140px] hover:from-white hover:to-gray-100 hover:text-gray-900 hover:border-gray-400 hover:shadow-lg" 
                        data-tab="taxation" 
                        id="btn-taxation">
                    Taxation
                </button>
            </div>

            <!-- Tab Panels -->
            <div class="tab-panels">
                <!-- Buyer Tab -->
                <div id="tab-buyer" class="tab-panel border-2 border-gray-300 rounded-b-lg rounded-tr-lg p-6 bg-white mt-0">
                    {% include 'accounts/transactions/partials/sales_invoice_buyer_tab.html' %}
                </div>

                <!-- Consignee Tab -->
                <div id="tab-consignee" class="tab-panel tab-hide border-2 border-gray-300 rounded-b-lg rounded-tr-lg p-6 bg-white mt-0">
                    {% include 'accounts/transactions/partials/sales_invoice_consignee_tab.html' %}
                </div>

                <!-- Goods Tab -->
                <div id="tab-goods" class="tab-panel tab-hide border-2 border-gray-300 rounded-b-lg rounded-tr-lg p-6 bg-white mt-0">
                    {% include 'accounts/transactions/partials/sales_invoice_items_tab.html' %}
                </div>

                <!-- Taxation Tab -->
                <div id="tab-taxation" class="tab-panel tab-hide border-2 border-gray-300 rounded-b-lg rounded-tr-lg p-6 bg-white mt-0">
                    {% include 'accounts/transactions/partials/sales_invoice_taxation_tab.html' %}
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Tab Navigation
document.addEventListener('DOMContentLoaded', function() {
    // CRITICAL FIX: Unhide all tabs DURING form submission using capture phase
    // This ensures fields are visible when browser collects form data
    const form = document.getElementById('salesInvoiceForm');
    if (form) {
        // Use capture phase (runs before bubbling) to unhide tabs early
        form.addEventListener('submit', function(e) {
            // Remove 'tab-hide' class from all tab panels IMMEDIATELY so their data gets submitted
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('tab-hide');
            });
        }, true);  // true = capture phase
    }

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');

            // Remove active styling from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-white', 'border-blue-500', 'text-blue-900', 'font-bold', 'shadow-xl', 'z-10');
                btn.classList.add('bg-gradient-to-b', 'from-gray-100', 'to-gray-200', 'border-gray-300', 'text-gray-700', 'font-semibold');
            });

            // Add active styling to clicked button
            this.classList.add('active');
            this.classList.remove('bg-gradient-to-b', 'from-gray-100', 'to-gray-200', 'border-gray-300', 'text-gray-700', 'font-semibold');
            this.classList.add('bg-white', 'border-blue-500', 'text-blue-900', 'font-bold', 'shadow-xl', 'z-10');

            // Hide all panels
            tabPanels.forEach(panel => panel.classList.add('tab-hide'));

            // Show target panel
            document.getElementById('tab-' + targetTab).classList.remove('tab-hide');
        });
    });

    // Handle Next/Previous buttons in tabs
    document.querySelectorAll('.btn-next-tab').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const nextTab = this.getAttribute('data-next-tab');
            if (nextTab) {
                const nextButton = document.querySelector(`[data-tab="${nextTab}"]`);
                if (nextButton) nextButton.click();
            }
        });
    });

    document.querySelectorAll('.btn-prev-tab').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const prevTab = this.getAttribute('data-prev-tab');
            if (prevTab) {
                const prevButton = document.querySelector(`[data-tab="${prevTab}"]`);
                if (prevButton) prevButton.click();
            }
        });
    });
});

// Auto-fill time fields with current time
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const timeString = now.toTimeString().substring(0, 5); // Format: HH:MM

    const timeOfIssue = document.getElementById('id_timeofissueinvoice');
    const timeOfRemoval = document.getElementById('id_timeofremoval');

    if (timeOfIssue) timeOfIssue.value = timeString;
    if (timeOfRemoval) timeOfRemoval.value = timeString;
});

// Commodity to Tariff Auto-fill using HTMX endpoint
document.getElementById('id_commodity')?.addEventListener('change', function() {
    const commodityId = this.value;
    if (commodityId) {
        fetch(`{% url 'accounts:sales_invoice_get_tariff' %}?commodity_id=${commodityId}`)
            .then(response => response.json())
            .then(data => {
                if (data.tariff) {
                    document.getElementById('id_tariffheading').value = data.tariff;
                }
            })
            .catch(error => console.error('Error fetching tariff:', error));
    } else {
        document.getElementById('id_tariffheading').value = '';
    }
});

// Helper function to populate dropdown with options (MUST BE GLOBAL for Copy from Buyer to work)
function populateDropdown(selectElement, items, valueField, textField, selectedValue) {
    // Clear existing options except the first one (placeholder)
    selectElement.innerHTML = '<option value="">Select ' + selectElement.getAttribute('data-label') + '</option>';

    // Add new options
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueField];
        option.textContent = item[textField];
        if (selectedValue && item[valueField] == selectedValue) {
            option.selected = true;
        }
        selectElement.appendChild(option);
    });
}

// Cascading Dropdowns: Country → State → City (for Buyer and Consignee)
document.addEventListener('DOMContentLoaded', function() {

    // Auto-load cascading data on page load if initial values exist
    function loadInitialCascadingData(countryId, stateSelectId, citySelectId, initialStateValue, initialCityValue) {
        const countrySelect = document.getElementById(countryId);
        const stateSelect = document.getElementById(stateSelectId);
        const citySelect = document.getElementById(citySelectId);

        if (!countrySelect || !stateSelect || !citySelect) return;

        const initialCountryValue = countrySelect.value;

        if (initialCountryValue) {
            // Load states for initial country
            fetch(`{% url 'accounts:sales_invoice_get_states' %}?country_id=${initialCountryValue}`)
                .then(response => response.json())
                .then(data => {
                    populateDropdown(stateSelect, data.states || [], 'sid', 'statename', initialStateValue);

                    // After states loaded, if we have initial state value, load cities
                    if (initialStateValue && stateSelect.value) {
                        return fetch(`{% url 'accounts:sales_invoice_get_cities' %}?state_id=${stateSelect.value}`);
                    }
                })
                .then(response => {
                    if (response) return response.json();
                })
                .then(data => {
                    if (data) {
                        populateDropdown(citySelect, data.cities || [], 'cityid', 'cityname', initialCityValue);
                    }
                })
                .catch(error => console.error('Error loading initial cascading data:', error));
        }
    }

    // Buyer Country → State
    document.getElementById('id_buyer_country')?.addEventListener('change', function() {
        const countryId = this.value;
        const stateSelect = document.getElementById('id_buyer_state');
        const citySelect = document.getElementById('id_buyer_city');

        if (countryId) {
            fetch(`{% url 'accounts:sales_invoice_get_states' %}?country_id=${countryId}`)
                .then(response => response.json())
                .then(data => {
                    populateDropdown(stateSelect, data.states || [], 'sid', 'statename');
                    // Clear city dropdown
                    citySelect.innerHTML = '<option value="">Select City</option>';
                })
                .catch(error => console.error('Error fetching states:', error));
        } else {
            stateSelect.innerHTML = '<option value="">Select State</option>';
            citySelect.innerHTML = '<option value="">Select City</option>';
        }
    });

    // Buyer State → City
    document.getElementById('id_buyer_state')?.addEventListener('change', function() {
        const stateId = this.value;
        const citySelect = document.getElementById('id_buyer_city');

        if (stateId) {
            fetch(`{% url 'accounts:sales_invoice_get_cities' %}?state_id=${stateId}`)
                .then(response => response.json())
                .then(data => {
                    populateDropdown(citySelect, data.cities || [], 'cityid', 'cityname');
                })
                .catch(error => console.error('Error fetching cities:', error));
        } else {
            citySelect.innerHTML = '<option value="">Select City</option>';
        }
    });

    // Consignee Country → State
    document.getElementById('id_cong_country')?.addEventListener('change', function() {
        const countryId = this.value;
        const stateSelect = document.getElementById('id_cong_state');
        const citySelect = document.getElementById('id_cong_city');

        if (countryId) {
            fetch(`{% url 'accounts:sales_invoice_get_states' %}?country_id=${countryId}`)
                .then(response => response.json())
                .then(data => {
                    populateDropdown(stateSelect, data.states || [], 'sid', 'statename');
                    // Clear city dropdown
                    citySelect.innerHTML = '<option value="">Select City</option>';
                })
                .catch(error => console.error('Error fetching states:', error));
        } else {
            stateSelect.innerHTML = '<option value="">Select State</option>';
            citySelect.innerHTML = '<option value="">Select City</option>';
        }
    });

    // Consignee State → City
    document.getElementById('id_cong_state')?.addEventListener('change', function() {
        const stateId = this.value;
        const citySelect = document.getElementById('id_cong_city');

        if (stateId) {
            fetch(`{% url 'accounts:sales_invoice_get_cities' %}?state_id=${stateId}`)
                .then(response => response.json())
                .then(data => {
                    populateDropdown(citySelect, data.cities || [], 'cityid', 'cityname');
                })
                .catch(error => console.error('Error fetching cities:', error));
        } else {
            citySelect.innerHTML = '<option value="">Select City</option>';
        }
    });

    // Auto-load buyer cascading data on page load
    // Read initial values from Django form's rendered selected options
    const buyerStateSelect = document.getElementById('id_buyer_state');
    const buyerCitySelect = document.getElementById('id_buyer_city');

    // Get initial values from selected options or data attributes
    let initialBuyerState = null;
    let initialBuyerCity = null;

    if (buyerStateSelect) {
        const selectedStateOption = Array.from(buyerStateSelect.options).find(opt => opt.selected && opt.value);
        initialBuyerState = selectedStateOption ? selectedStateOption.value : (buyerStateSelect.dataset.initial || null);
    }

    if (buyerCitySelect) {
        const selectedCityOption = Array.from(buyerCitySelect.options).find(opt => opt.selected && opt.value);
        initialBuyerCity = selectedCityOption ? selectedCityOption.value : (buyerCitySelect.dataset.initial || null);
    }

    loadInitialCascadingData('id_buyer_country', 'id_buyer_state', 'id_buyer_city', initialBuyerState, initialBuyerCity);

    // Auto-load consignee cascading data on page load
    const congStateSelect = document.getElementById('id_cong_state');
    const congCitySelect = document.getElementById('id_cong_city');

    let initialCongState = null;
    let initialCongCity = null;

    if (congStateSelect) {
        const selectedStateOption = Array.from(congStateSelect.options).find(opt => opt.selected && opt.value);
        initialCongState = selectedStateOption ? selectedStateOption.value : (congStateSelect.dataset.initial || null);
    }

    if (congCitySelect) {
        const selectedCityOption = Array.from(congCitySelect.options).find(opt => opt.selected && opt.value);
        initialCongCity = selectedCityOption ? selectedCityOption.value : (congCitySelect.dataset.initial || null);
    }

    loadInitialCascadingData('id_cong_country', 'id_cong_state', 'id_cong_city', initialCongState, initialCongCity);
});

// Copy Buyer to Consignee functionality
document.getElementById('copy-buyer-btn')?.addEventListener('click', async function() {
    console.log('Copy from Buyer clicked');

    // Copy all buyer fields to consignee fields
    document.getElementById('id_cong_name').value = document.getElementById('id_buyer_name').value;
    document.getElementById('id_cong_add').value = document.getElementById('id_buyer_add').value;

    // Get buyer values
    const buyerCountryId = document.getElementById('id_buyer_country').value;
    const buyerStateId = document.getElementById('id_buyer_state').value;
    const buyerCityId = document.getElementById('id_buyer_city').value;

    console.log('Buyer location IDs:', {buyerCountryId, buyerStateId, buyerCityId});

    // Set country first
    document.getElementById('id_cong_country').value = buyerCountryId;

    // Load states for the selected country
    if (buyerCountryId && buyerStateId) {
        try {
            const stateSelect = document.getElementById('id_cong_state');
            const citySelect = document.getElementById('id_cong_city');

            console.log('Fetching states for country:', buyerCountryId);
            // Fetch and populate states
            const statesResponse = await fetch(`{% url 'accounts:sales_invoice_get_states' %}?country_id=${buyerCountryId}`);
            const statesData = await statesResponse.json();
            console.log('States fetched:', statesData.states?.length);

            populateDropdown(stateSelect, statesData.states || [], 'sid', 'statename');

            // Small delay to ensure DOM is updated
            await new Promise(resolve => setTimeout(resolve, 50));

            // Set the state value after states are loaded (convert to string to ensure match)
            stateSelect.value = String(buyerStateId);
            console.log('State value set to:', stateSelect.value, 'Expected:', buyerStateId);

            // Fetch and populate cities for the selected state
            if (buyerCityId) {
                console.log('Fetching cities for state:', buyerStateId);
                const citiesResponse = await fetch(`{% url 'accounts:sales_invoice_get_cities' %}?state_id=${buyerStateId}`);
                const citiesData = await citiesResponse.json();
                console.log('Cities fetched:', citiesData.cities?.length);

                populateDropdown(citySelect, citiesData.cities || [], 'cityid', 'cityname');

                // Small delay to ensure DOM is updated
                await new Promise(resolve => setTimeout(resolve, 50));

                // Set the city value after cities are loaded (convert to string to ensure match)
                citySelect.value = String(buyerCityId);
                console.log('City value set to:', citySelect.value, 'Expected:', buyerCityId);
            }

            console.log('Location copy completed successfully');
        } catch (error) {
            console.error('Error copying buyer location data:', error);
            alert('Error copying location data. Please select state and city manually.');
        }
    }

    // Copy other fields
    document.getElementById('id_cong_cotper').value = document.getElementById('id_buyer_cotper').value;
    document.getElementById('id_cong_ph').value = document.getElementById('id_buyer_ph').value;
    document.getElementById('id_cong_mob').value = document.getElementById('id_buyer_mob').value;
    document.getElementById('id_cong_email').value = document.getElementById('id_buyer_email').value;
    document.getElementById('id_cong_tin').value = document.getElementById('id_buyer_tin').value;
    document.getElementById('id_cong_fax').value = document.getElementById('id_buyer_fax').value;
    document.getElementById('id_cong_vat').value = document.getElementById('id_buyer_vat').value;
    document.getElementById('id_cong_ecc').value = document.getElementById('id_buyer_ecc').value;

    console.log('Copy from Buyer completed');
});
</script>
{% endblock %}
