{% extends 'core/base.html' %}

{% block title %}Add Items to BOM - {{ wono }} - Design{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 py-4 max-w-7xl">
    <!-- Page Header -->
    <div class="bg-white shadow-sm border-b border-gray-200 mb-4 -mx-4 px-4 py-3">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Add Items to BOM</h1>
                <div class="mt-2 text-sm text-gray-600">
                    <p>Work Order: <span class="font-semibold">{{ wono }}</span></p>
                    {% if parent_item %}
                    <p>Parent Assembly: <span class="font-semibold">{{ parent_item.itemcode }}</span> - {{ parent_item.manfdesc|truncatewords:10 }}</p>
                    {% endif %}
                    {% if parent_partno %}
                    <p>Part Number: <span class="font-semibold">{{ parent_partno }}</span></p>
                    {% endif %}
                </div>
            </div>
            <form method="post" action="{% url 'design:bom-wizard-cancel' wono parent_cid %}">
                {% csrf_token %}
                <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-4 py-2 rounded-md transition-colors text-sm">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <!-- 4-Tab Wizard using Alpine.js -->
    <div class="bg-white rounded border border-gray-200 p-4" x-data="{ activeTab: 'tab1' }">

        <!-- Tab Headers -->
        <div class="flex border-b border-gray-200 mb-4">
            <button @click="activeTab = 'tab1'"
                    :class="activeTab === 'tab1' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300'"
                    class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                <i class="fas fa-search mr-1"></i> Item Master
            </button>
            <button @click="activeTab = 'tab2'"
                    :class="activeTab === 'tab2' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300'"
                    class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                <i class="fas fa-plus-circle mr-1"></i> New Items
            </button>
            <button @click="activeTab = 'tab3'"
                    :class="activeTab === 'tab3' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300'"
                    class="py-2 px-4 border-b-2 font-medium text-sm transition-colors">
                <i class="fas fa-copy mr-1"></i> Copy From
            </button>
            <button @click="activeTab = 'tab4'"
                    :class="activeTab === 'tab4' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800 hover:border-gray-300'"
                    class="py-2 px-4 border-b-2 font-medium text-sm transition-colors relative">
                <i class="fas fa-list-check mr-1"></i> Selected Items
                {% if temp_count > 0 %}
                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{{ temp_count }}</span>
                {% endif %}
            </button>
        </div>

        <!-- Tab 1: Item Master (Search & Add Existing) -->
        <div x-show="activeTab === 'tab1'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-800">Search Item Master</h2>

                <!-- Search Form -->
                <form hx-get="{% url 'design:bom-wizard-search' wono parent_cid %}"
                      hx-target="#search-results"
                      hx-indicator="#search-spinner"
                      class="bg-gray-50 p-4 rounded">

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search By</label>
                            <select name="search_by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="itemcode">Item Code</option>
                                <option value="description">Description</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.cid }}">{{ category.categoryname }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search Text</label>
                            <input type="text"
                                   name="search"
                                   placeholder="Enter search term..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md transition-colors">
                                <i class="fas fa-search mr-1"></i> Search
                            </button>
                        </div>
                    </div>

                    <div id="search-spinner" class="htmx-indicator text-center py-4">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-sm"></i>
                        <p class="text-sm text-gray-600 mt-2">Searching...</p>
                    </div>
                </form>

                <!-- Search Results -->
                <div id="search-results" class="min-h-[200px]">
                    <p class="text-center text-gray-500 py-8">Use the search form above to find items</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: New Items -->
        <div x-show="activeTab === 'tab2'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-800">Create New Item</h2>

                <form method="post" action="{% url 'design:bom-wizard-add-new' wono parent_cid %}" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}

                    <!-- Auto-generated Part Number Info -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <strong>Auto-Generated Part Number:</strong>
                                    {% if equip_no and unit_no and next_part_no %}
                                    {{ equip_no }}-{{ unit_no }}-{{ next_part_no }}
                                    {% else %}
                                    Will be generated automatically
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Equipment Number (read-only) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Equipment No</label>
                            <input type="text"
                                   name="equip_no"
                                   value="{{ equip_no }}"
                                   readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                        </div>

                        <!-- Unit Number (read-only) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Unit No</label>
                            <input type="text"
                                   name="unit_no"
                                   value="{{ unit_no }}"
                                   readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                        </div>

                        <!-- Part Number (read-only) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Part No</label>
                            <input type="text"
                                   name="part_no"
                                   value="{{ next_part_no }}"
                                   readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-red-500">*</span></label>
                        <textarea name="manfdesc"
                                  rows="3"
                                  required
                                  placeholder="Enter detailed description of the item..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">UOM <span class="text-red-500">*</span></label>
                            <select name="uombasic" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select UOM</option>
                                {% for uom in uom_list %}
                                <option value="{{ uom.id }}">{{ uom.symbol }} - {{ uom.unitname }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity <span class="text-red-500">*</span></label>
                            <input type="number"
                                   name="qty"
                                   value="1"
                                   step="0.001"
                                   min="0.001"
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
                        <input type="text"
                               name="material"
                               placeholder="e.g., Mild Steel, Aluminum, etc."
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Drawing/Image File</label>
                            <input type="file"
                                   name="drawing_file"
                                   accept=".pdf,.dwg,.dxf,.jpg,.jpeg,.png"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">PDF, DWG, DXF, JPG, PNG (Max 10MB)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Specification Sheet</label>
                            <input type="file"
                                   name="spec_file"
                                   accept=".pdf,.doc,.docx,.xls,.xlsx"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">PDF, DOC, XLS (Max 10MB)</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Remarks</label>
                        <textarea name="remark"
                                  rows="2"
                                  placeholder="Optional remarks or notes..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-plus mr-2"></i> Add to Pending List
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab 3: Copy From (Future Implementation) -->
        <div x-show="activeTab === 'tab3'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="text-center py-12">
                <i class="fas fa-construction text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Copy From Other Work Orders</h3>
                <p class="text-gray-600">This feature will be implemented in a future update.</p>
                <p class="text-sm text-gray-500 mt-2">You will be able to copy BOM items from other work orders.</p>
            </div>
        </div>

        <!-- Tab 4: Selected Items (Review & Commit) -->
        <div x-show="activeTab === 'tab4'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800">Pending Items ({{ temp_count }})</h2>
                    {% if temp_count > 0 %}
                    <form method="post" action="{% url 'design:bom-wizard-commit' wono parent_cid %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-check mr-2"></i> Add to BOM
                        </button>
                    </form>
                    {% endif %}
                </div>

                {% if temp_items %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SN</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item Code</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">UOM</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Req Qty</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in temp_items %}
                            <tr>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ forloop.counter }}</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ item.itemcode }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ item.manfdesc|truncatewords:10 }}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ item.uom }}</td>
                                <td class="px-4 py-3 text-sm font-semibold text-blue-600">{{ item.qty }}</td>
                                <td class="px-4 py-3 text-sm">
                                    {% if item.is_new %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        New
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                        Existing
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <form method="post" action="{% url 'design:bom-wizard-remove' wono parent_cid %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="index" value="{{ item.index }}">
                                        <button type="submit" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>Review before committing:</strong> These items are in temporary storage. Click "Add to BOM" above to permanently add them to the BOM structure.
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12 bg-gray-50 rounded">
                    <i class="fas fa-inbox text-gray-400 text-6xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Pending Items</h3>
                    <p class="text-gray-600">Add items from "Item Master" or "New Items" tabs.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}








