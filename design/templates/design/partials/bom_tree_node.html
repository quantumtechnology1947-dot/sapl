<!-- SAP Fiori Style BOM Tree Node -->
{% load static %}

<div class="bom-node" 
     data-node-id="{{ node.item.cid }}"
     data-level="{{ node.level }}"
     @mouseenter="hoveredNode = {{ node.item.cid }}"
     @mouseleave="hoveredNode = null">
    
    <!-- Node Card with Level-based Styling -->
    <div class="bg-white rounded-lg shadow-sm border transition-all duration-200 hover:shadow-md
                {% if node.level == 0 %}
                    border-l-4 border-l-blue-500 ml-0
                {% elif node.level == 1 %}
                    border-l-4 border-l-indigo-500 ml-8
                {% else %}
                    border-l-4 border-l-purple-500 ml-16
                {% endif %}">
        
        <!-- Node Header -->
        <div class="p-4">
            <div class="flex items-start space-x-3">
                
                <!-- Bulk Mode Checkbox -->
                <template x-if="bulkMode">
                    <div class="flex items-center h-6">
                        <input type="checkbox" 
                               :checked="selectedNodes.has({{ node.item.cid }})"
                               @change="selectNode({{ node.item.cid }})"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer">
                    </div>
                </template>
                
                <!-- Expand/Collapse Button -->
                <div class="flex-shrink-0">
                    {% if node.children %}
                        <button @click="toggleNode({{ node.item.cid }})"
                                :class="expandedNodes.has({{ node.item.cid }}) ? 'rotate-90' : ''"
                                class="flex items-center justify-center w-6 h-6 rounded hover:bg-gray-100 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 text-gray-600 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    {% else %}
                        <div class="w-6 h-6"></div>
                    {% endif %}
                </div>
                
                <!-- Level Icon -->
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center w-10 h-10 rounded-lg
                                {% if node.level == 0 %}
                                    bg-blue-100 text-blue-600
                                {% elif node.level == 1 %}
                                    bg-indigo-100 text-indigo-600
                                {% else %}
                                    bg-purple-100 text-purple-600
                                {% endif %}">
                        {% if node.level == 0 %}
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                            </svg>
                        {% elif node.level == 1 %}
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15.586 13H14a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        {% else %}
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                            </svg>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <!-- Level Badge & Item Code -->
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                            {% if node.level == 0 %}
                                                bg-blue-100 text-blue-800
                                            {% elif node.level == 1 %}
                                                bg-indigo-100 text-indigo-800
                                            {% else %}
                                                bg-purple-100 text-purple-800
                                            {% endif %}">
                                    {% if node.level == 0 %}
                                        Assembly
                                    {% elif node.level == 1 %}
                                        Sub-Assembly
                                    {% else %}
                                        Part
                                    {% endif %}
                                </span>
                                <span class="text-sm font-semibold text-gray-900">
                                    {{ node.item.itemid.itemcode|default:node.item.partno|default:'N/A' }}
                                </span>
                            </div>
                            
                            <!-- Description -->
                            <p class="text-sm text-gray-600 line-clamp-2">
                                {{ node.item.itemid.manfdesc|default:'No description' }}
                            </p>
                            
                            <!-- Metadata Row -->
                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                <span class="flex items-center">
                                    <span class="font-medium text-gray-700">Qty:</span>
                                    <span class="ml-1">{{ node.bom_qty|default:node.item.qty|default:1|floatformat:3 }}</span>
                                </span>
                                <span class="flex items-center">
                                    <span class="font-medium text-gray-700">UOM:</span>
                                    <span class="ml-1">{{ node.item.itemid.uom.uom|default:'EA' }}</span>
                                </span>
                                {% if node.item.itemid.class_field %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                                {% if node.item.itemid.class_field == 1 %}
                                                    bg-green-100 text-green-800
                                                {% elif node.item.itemid.class_field == 2 %}
                                                    bg-orange-100 text-orange-800
                                                {% endif %}">
                                        {% if node.item.itemid.class_field == 1 %}
                                            Bought-Out
                                        {% elif node.item.itemid.class_field == 2 %}
                                            Manufacturing
                                        {% endif %}
                                    </span>
                                {% endif %}
                                {% if node.item.revision %}
                                    <span class="flex items-center">
                                        <span class="font-medium text-gray-700">Rev:</span>
                                        <span class="ml-1">{{ node.item.revision }}</span>
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons (Show on Hover) -->
            <div x-show="hoveredNode === {{ node.item.cid }}"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="flex items-center space-x-2 mt-3 pt-3 border-t border-gray-100">
                
                {% if node.level < 2 %}
                    <button @click="openAddWizard({{ node.item.cid }}, {{ node.level }}, '{{ node.item.itemid.itemcode|default:node.item.partno|default:"N/A" }}')"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        {% if node.level == 0 %}
                            Add Sub-Assembly
                        {% else %}
                            Add Parts
                        {% endif %}
                    </button>
                {% endif %}
                
                <button @click="editNode({{ node.item.cid }})"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit
                </button>
                
                <button @click="if(confirm('Delete this item and all its children?')) { deleteNode({{ node.item.cid }}) }"
                        class="inline-flex items-center px-3 py-1.5 border border-red-300 text-xs font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Children (Recursive) -->
    {% if node.children %}
        <div x-show="expandedNodes.has({{ node.item.cid }})"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform -translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform -translate-y-2"
             class="mt-3 space-y-3">
            {% for child in node.children %}
                {% include 'design/partials/bom_tree_node.html' with node=child %}
            {% endfor %}
        </div>
    {% endif %}
</div>
