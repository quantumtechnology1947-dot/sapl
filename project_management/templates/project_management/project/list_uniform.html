{% extends "core/base.html" %}

{% block title %}Project Planning - Cortex ERP{% endblock %}
{% block page_title %}Project Planning{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4">
    <!-- Header -->
    <div class="bg-white rounded border border-gray-200 p-3 mb-4">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-sm font-semibold text-gray-800">Project Planning - File Management</h2>
        </div>

        <!-- Search Form -->
        <form method="get" class="grid grid-cols-3 gap-3 items-end">
            <!-- WO Number Search -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">WO Number:</label>
                <input type="text"
                       name="search_wono"
                       value="{{ request.GET.search_wono }}"
                       placeholder="Enter WO Number..."
                       class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- WO Category Dropdown -->
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">WO Category:</label>
                <select name="search_category"
                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Categories</option>
                    {% for category in wo_categories %}
                    <option value="{{ category.cid }}" {% if request.GET.search_category == category.cid|stringformat:"s" %}selected{% endif %}>
                        {{ category.symbol }} - {{ category.cname }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Search Button -->
            <div>
                <button type="submit"
                        class="w-full px-4 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors inline-flex items-center justify-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Search
                </button>
            </div>
        </form>

        {% if request.GET.search_wono or request.GET.search_category %}
        <div class="mt-2">
            <a href="{% url 'project_management:project-list' %}"
               class="text-xs text-gray-600 hover:text-gray-800 underline">
                Clear Filters
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-2 gap-4">
        <!-- Left Panel: Work Orders List -->
        <div class="bg-white rounded border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b">
                <h3 class="text-sm font-semibold text-gray-700">Work Orders</h3>
                <p class="text-xs text-gray-500">Click a WO Number to view/manage planning files</p>
            </div>
            <div class="overflow-y-auto max-h-[600px]">
                <table class="w-full table-fixed divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="w-[8%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">SN</th>
                            <th class="w-[15%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Fin Year</th>
                            <th class="w-[20%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">WO No</th>
                            <th class="w-[20%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Date</th>
                            <th class="w-[37%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Project Title</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for wo in work_orders %}
                        <tr class="hover:bg-gray-50 {% if selected_wono == wo.wono %}bg-blue-50{% endif %}">
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-900 text-right">
                                {{ forloop.counter }}
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-600 text-center">
                                {{ wo.finyear }}
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-[11px]">
                                <a href="?wono={{ wo.wono }}{% if request.GET.search_wono %}&search_wono={{ request.GET.search_wono }}{% endif %}{% if request.GET.search_category %}&search_category={{ request.GET.search_category }}{% endif %}"
                                   class="text-blue-600 hover:text-blue-800 font-medium">
                                    {{ wo.wono }}
                                </a>
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-900">
                                {{ wo.date }}
                            </td>
                            <td class="px-2 py-2 text-[11px] text-gray-900 truncate" title="{{ wo.title }}">
                                {{ wo.title }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-12 text-center text-gray-500 text-sm">
                                No work orders found. Try adjusting your search filters.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Panel: Planning Files (shown when WO is selected) -->
        <div class="bg-white rounded border border-gray-200 overflow-hidden">
            {% if show_files_panel %}
            <div class="bg-purple-50 px-4 py-2 border-b border-purple-200">
                <h3 class="text-sm font-semibold text-purple-900">Planning Files for WO: {{ selected_wono }}</h3>
                <p class="text-xs text-purple-700">Upload, view, and manage planning documents</p>
            </div>

            <!-- File Upload Form -->
            <div class="p-4 bg-gray-50 border-b">
                <form method="post" enctype="multipart/form-data" class="space-y-2">
                    {% csrf_token %}
                    <input type="hidden" name="wono" value="{{ selected_wono }}">
                    <input type="hidden" name="search_wono" value="{{ request.GET.search_wono }}">
                    <input type="hidden" name="search_category" value="{{ request.GET.search_category }}">
                    <div class="flex items-end gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Select File:</label>
                            <input type="file"
                                   name="file"
                                   required
                                   class="w-full text-xs border border-gray-300 rounded-md px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <button type="submit"
                                name="upload_file"
                                class="px-4 py-1.5 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 transition-colors inline-flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Upload
                        </button>
                    </div>
                </form>
            </div>

            <!-- Files List -->
            <div class="overflow-y-auto max-h-[480px]">
                <table class="w-full table-fixed divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="w-[8%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">SN</th>
                            <th class="w-[20%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">Date</th>
                            <th class="w-[20%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">WO No</th>
                            <th class="w-[35%] px-2 py-2 text-left text-[10px] font-medium text-gray-500 uppercase">File</th>
                            <th class="w-[17%] px-2 py-2 text-center text-[10px] font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for file in planning_files %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-900 text-right">
                                {{ forloop.counter }}
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-900">
                                {{ file.sysdate }}
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-[11px] text-gray-600">
                                {{ file.wono }}
                            </td>
                            <td class="px-2 py-2 text-[11px] text-gray-900 truncate" title="{{ file.filename }}">
                                {% if file.has_file %}
                                    <a href="{% url 'project_management:project-download' file.id %}"
                                       class="text-blue-600 hover:text-blue-800">
                                        {{ file.filename }}
                                    </a>
                                {% else %}
                                    <span class="text-gray-400">No file</span>
                                {% endif %}
                            </td>
                            <td class="px-2 py-2 whitespace-nowrap text-center">
                                <div class="flex items-center justify-center gap-2">
                                    {% if file.has_file %}
                                    <a href="{% url 'project_management:project-download' file.id %}"
                                       class="text-green-600 hover:text-green-800 text-xs">
                                        Download
                                    </a>
                                    {% endif %}
                                    <form method="post" class="inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="file_id" value="{{ file.id }}">
                                        <input type="hidden" name="wono" value="{{ selected_wono }}">
                                        <input type="hidden" name="search_wono" value="{{ request.GET.search_wono }}">
                                        <input type="hidden" name="search_category" value="{{ request.GET.search_category }}">
                                        <button type="submit"
                                                name="delete_file"
                                                class="text-red-600 hover:text-red-800 text-xs">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-12 text-center text-gray-500 text-sm">
                                No planning files uploaded yet. Use the form above to upload files.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <!-- No WO Selected State -->
            <div class="p-12 text-center">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="text-sm font-medium text-gray-900 mb-2">No Work Order Selected</h3>
                <p class="text-xs text-gray-500">
                    Click on a WO Number from the left panel to view and manage planning files
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}








