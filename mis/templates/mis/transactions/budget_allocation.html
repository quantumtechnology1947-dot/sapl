{% extends "core/base.html" %}
{% load static %}

{% block title %}Budget Allocation - {{ wo_no }}{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include "core/components/layout/breadcrumb.html" with items=breadcrumb_items %}
    
    {% include "core/components/layout/page_header.html" with title="Budget Allocation" subtitle="Work Order: "|add:wo_no %}
    
    <!-- Work Order Info Card -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>WO No:</strong> {{ work_order.wono }}
                </div>
                <div class="col-md-6">
                    <strong>Project Title:</strong> {{ work_order.taskprojecttitle|default:"-" }}
                </div>
                <div class="col-md-3">
                    <strong>Customer:</strong> {{ work_order.customerid }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Allocation Form -->
    <form method="post" id="budgetForm">
        {% csrf_token %}
        <input type="hidden" name="wo_no" value="{{ wo_no }}">
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Budget Code Allocation</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-secondary" id="toggleEditBtn">
                        <i class="bi bi-pencil"></i> Edit Mode
                    </button>
                    <button type="submit" class="btn btn-sm btn-success hidden" id="saveBtn">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="w-[3%]">SN</th>
                                <th class="w-[5%]">
                                    <input type="checkbox" id="selectAll" title="Select All">
                                </th>
                                <th class="w-[5%]">ID</th>
                                <th class="w-[15%]">Description</th>
                                <th class="w-[7%]">Symbol</th>
                                <th class="w-[10%]">Budget Code</th>
                                <th class="w-[10%] text-end">Budget Amount</th>
                                <th class="w-[9%] text-end">PO</th>
                                <th class="w-[8%] text-end">Tax</th>
                                <th class="w-[8%] text-end">Cash Pay</th>
                                <th class="w-[8%] text-end">Cash Rec</th>
                                <th class="w-[9%] text-end">Balance Budget</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary_list %}
                            <tr {% if item.has_allocation %}class="table-info"{% endif %}>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <input type="checkbox" 
                                           name="selected_codes" 
                                           value="{{ item.id }}"
                                           class="budget-checkbox"
                                           {% if item.has_allocation %}checked{% endif %}>
                                </td>
                                <td>{{ item.id }}</td>
                                <td>{{ item.description }}</td>
                                <td class="text-center">{{ item.symbol }}</td>
                                <td>{{ item.budget_code }}</td>
                                <td class="text-end">
                                    <span class="amount-display">{{ item.budget_amount|floatformat:2 }}</span>
                                    <input type="number" 
                                           name="amount_{{ item.id }}" 
                                           value="{{ item.budget_amount }}"
                                           step="0.01"
                                           class="form-control form-control-sm amount-input hidden">
                                </td>
                                <td class="text-end">{{ item.po_amount|floatformat:2 }}</td>
                                <td class="text-end">{{ item.tax_amount|floatformat:2 }}</td>
                                <td class="text-end">{{ item.cash_pay|floatformat:2 }}</td>
                                <td class="text-end">{{ item.cash_rec|floatformat:2 }}</td>
                                <td class="text-end {% if item.balance_budget < 0 %}text-danger{% endif %}">
                                    {{ item.balance_budget|floatformat:2 }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr class="fw-bold">
                                <td colspan="6" class="text-end">Total:</td>
                                <td class="text-end">{{ totals.budget_amount|floatformat:2 }}</td>
                                <td class="text-end">{{ totals.po_amount|floatformat:2 }}</td>
                                <td class="text-end">{{ totals.tax_amount|floatformat:2 }}</td>
                                <td class="text-end">{{ totals.cash_pay|floatformat:2 }}</td>
                                <td class="text-end">{{ totals.cash_rec|floatformat:2 }}</td>
                                <td class="text-end {% if totals.balance_budget < 0 %}text-danger{% endif %}">
                                    {{ totals.balance_budget|floatformat:2 }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Action Buttons -->
    <div class="mt-3">
        <a href="{% url 'mis:wo_search' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Search
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleEditBtn = document.getElementById('toggleEditBtn');
    const saveBtn = document.getElementById('saveBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const budgetCheckboxes = document.querySelectorAll('.budget-checkbox');
    const amountDisplays = document.querySelectorAll('.amount-display');
    const amountInputs = document.querySelectorAll('.amount-input');
    let editMode = false;
    
    // Toggle edit mode
    toggleEditBtn.addEventListener('click', function() {
        editMode = !editMode;
        
        if (editMode) {
            // Show inputs, hide displays
            amountDisplays.forEach(display => display.classList.add('hidden'));
            amountInputs.forEach(input => input.classList.remove('hidden'));
            toggleEditBtn.innerHTML = '<i class="bi bi-x"></i> Cancel';
            toggleEditBtn.classList.remove('btn-secondary');
            toggleEditBtn.classList.add('btn-warning');
            saveBtn.classList.remove('hidden');
        } else {
            // Show displays, hide inputs
            amountDisplays.forEach(display => display.classList.remove('hidden'));
            amountInputs.forEach(input => input.classList.add('hidden'));
            toggleEditBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Mode';
            toggleEditBtn.classList.remove('btn-warning');
            toggleEditBtn.classList.add('btn-secondary');
            saveBtn.classList.add('hidden');
        }
    });
    
    // Select all functionality
    selectAllCheckbox.addEventListener('change', function() {
        budgetCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Update select all when individual checkboxes change
    budgetCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(budgetCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(budgetCheckboxes).every(cb => !cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
        });
    });
    
    // Form submission validation
    document.getElementById('budgetForm').addEventListener('submit', function(e) {
        const checkedBoxes = Array.from(budgetCheckboxes).filter(cb => cb.checked);
        
        if (checkedBoxes.length === 0) {
            e.preventDefault();
            alert('Please select at least one budget code to allocate.');
            return false;
        }
        
        // Validate amounts for checked items
        let hasError = false;
        checkedBoxes.forEach(checkbox => {
            const id = checkbox.value;
            const amountInput = document.querySelector(`input[name="amount_${id}"]`);
            if (amountInput && (amountInput.value === '' || parseFloat(amountInput.value) < 0)) {
                hasError = true;
                amountInput.classList.add('is-invalid');
            } else if (amountInput) {
                amountInput.classList.remove('is-invalid');
            }
        });
        
        if (hasError) {
            e.preventDefault();
            alert('Please enter valid amounts for all selected budget codes.');
            return false;
        }
    });
});
</script>

<style>
.table-info {
    background-color: #e7f3ff !important;
}

.amount-input {
    width: 120px;
    text-align: right;
}

.amount-input.is-invalid {
    border-color: #dc3545;
}
</style>
{% endblock %}
